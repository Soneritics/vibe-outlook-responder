"use strict";(self.webpackChunkvibe_outlook_responder=self.webpackChunkvibe_outlook_responder||[]).push([[452],{645(e,t,n){n.d(t,{U:()=>r});class r{insertionHistory=[];async insertContent(e,t){return new Promise((n,r)=>{Office.context.mailbox.item.body.getAsync(Office.CoercionType.Html,async s=>{if(s.status===Office.AsyncResultStatus.Failed)return void r(new Error(s.error?.message||"Failed to get email body"));const o=s.value||"";let i;if(-1!==t&&t<o.length){const n=o.substring(0,t),r=o.substring(t);i=`${n}${this.formatContentForInsertion(e)}\n\n${r}`}else i=`${this.formatContentForInsertion(e)}\n\n${o}`;Office.context.mailbox.item.body.setAsync(i,{coercionType:Office.CoercionType.Html},s=>{s.status!==Office.AsyncResultStatus.Failed?(this.insertionHistory.push({content:e,position:t,timestamp:Date.now()}),n()):r(new Error(s.error?.message||"Failed to set email body"))})})})}async insertContentAtPosition(e,t){if(t<0)throw new Error("Invalid position: must be non-negative");return new Promise((n,r)=>{Office.context.mailbox.item.body.getAsync(Office.CoercionType.Html,async s=>{if(s.status===Office.AsyncResultStatus.Failed)return void r(new Error(s.error?.message||"Failed to get email body"));const o=s.value||"";if(t>o.length)return void r(new Error("Position exceeds content length"));const i=o.substring(0,t),a=o.substring(t),c=`${i}${this.formatContentForInsertion(e)}${a}`;Office.context.mailbox.item.body.setAsync(c,{coercionType:Office.CoercionType.Html},s=>{s.status!==Office.AsyncResultStatus.Failed?(this.insertionHistory.push({content:e,position:t,timestamp:Date.now()}),n()):r(new Error(s.error?.message||"Failed to set email body"))})})})}async prependContent(e){return new Promise((t,n)=>{Office.context.mailbox.item.body.getAsync(Office.CoercionType.Html,async r=>{if(r.status===Office.AsyncResultStatus.Failed)return void n(new Error(r.error?.message||"Failed to get email body"));const s=r.value||"",o=`${this.formatContentForInsertion(e)}\n\n${s}`;Office.context.mailbox.item.body.setAsync(o,{coercionType:Office.CoercionType.Html},r=>{r.status!==Office.AsyncResultStatus.Failed?(this.insertionHistory.push({content:e,position:0,timestamp:Date.now()}),t()):n(new Error(r.error?.message||"Failed to set email body"))})})})}async appendContent(e){return new Promise((t,n)=>{Office.context.mailbox.item.body.getAsync(Office.CoercionType.Html,async r=>{if(r.status===Office.AsyncResultStatus.Failed)return void n(new Error(r.error?.message||"Failed to get email body"));const s=r.value||"",o=`${s}\n\n${this.formatContentForInsertion(e)}`;Office.context.mailbox.item.body.setAsync(o,{coercionType:Office.CoercionType.Html},r=>{r.status!==Office.AsyncResultStatus.Failed?(this.insertionHistory.push({content:e,position:s.length,timestamp:Date.now()}),t()):n(new Error(r.error?.message||"Failed to set email body"))})})})}getInsertionHistory(){return[...this.insertionHistory]}canUndo(){return this.insertionHistory.length>0}formatAsHtml(e){return/<[^>]+>/.test(e)?e:`<p>${e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>")}</p>`}formatContentForInsertion(e){return`<div style="margin-bottom: 10px;">${this.formatAsHtml(e)}</div>`}}},3701(e,t,n){n.d(t,{Q:()=>r});class r{async parseThread(e){if(!e||""===e.trim())return{messages:[],currentMessage:""};const t=this.detectEmailClient(e),n=this.extractMessages(e,t);return{messages:n,currentMessage:n.length>0&&n[0]?n[0].content:""}}extractPlainText(e){if(!e)return"";let t=e.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"");return t=t.replace(/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/gi,""),t=t.replace(/<\/?(div|p|br|li|tr)[^>]*>/gi,"\n"),t=t.replace(/<[^>]+>/g,""),t=this.decodeHtmlEntities(t),t=t.replace(/\n\s*\n/g,"\n\n"),t=t.trim(),t}detectEmailClient(e){return e.includes("border-top:solid #B5C4DF")||e.includes('class="Signature"')?"outlook":e.includes('class="gmail_quote"')||e.includes('class="gmail_signature"')?"gmail":"unknown"}combineMessagesForContext(e){return 0===e.length?"":e.map(e=>{let t="";return e.from&&(t+=`From: ${e.from}\n`),e.date&&(t+=`Date: ${e.date}\n`),t+=`\n${e.content}\n`,t}).join("\n---\n\n")}sanitizeHtml(e){if(!e)return"";let t=e.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"");return t=t.replace(/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/gi,""),t=t.replace(/\s*on\w+\s*=\s*["'][^"']*["']/gi,""),t=t.replace(/\s*on\w+\s*=\s*[^\s>]*/gi,""),t=t.replace(/javascript:/gi,""),t=t.replace(/src=["']data:image[^"']*["']/gi,'src=""'),t}extractMessages(e,t){const n=this.sanitizeHtml(e);return"outlook"===t?this.extractOutlookMessages(n):"gmail"===t?this.extractGmailMessages(n):this.extractGenericMessages(n)}extractOutlookMessages(e){const t=[],n=e.split(/<div[^>]*border-top:solid\s+#[A-F0-9]+[^>]*>/i);for(const e of n)if(e.trim()){const n=this.extractMessageMetadata(e);t.push(n)}return t}extractGmailMessages(e){const t=[],n=e.split(/<div[^>]*class=["']gmail_quote["'][^>]*>/i);for(const e of n)if(e.trim()){const n=this.extractMessageMetadata(e);t.push(n)}return t}extractGenericMessages(e){const t=e.split(/<hr[^>]*>/i);return t.length>1?t.map(e=>this.extractMessageMetadata(e)):[this.extractMessageMetadata(e)]}extractMessageMetadata(e){const t={content:""},n=e.match(/From:\s*([^\n<]+)/i);n&&n[1]&&(t.from=n[1].trim());const r=e.match(/Date:\s*([^\n<]+)/i);return r&&r[1]&&(t.date=r[1].trim()),t.content=this.extractPlainText(e),t}decodeHtmlEntities(e){const t={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'","&nbsp;":" "};return e.replace(/&[a-z]+;|&#\d+;/gi,e=>t[e.toLowerCase()]||e)}}},7762(e,t,n){n.d(t,{Z:()=>r});class r{SIGNATURE_PATTERNS=["Best regards","Sincerely","Regards","Thank you","Thanks","Cheers","Warm regards","Kind regards","Sent from my","Get Outlook for"];SIGNATURE_CLASSES=["Signature","signature","gmail_signature","email-signature"];detectSignature(e){if(!e||""===e.trim())return-1;const t=this.detectByClass(e);if(-1!==t)return t;const n=this.detectByPattern(e);if(-1!==n)return n;const r=this.detectByStructure(e);return-1!==r?r:-1}getSignatureConfidence(e){if(!e)return 0;let t=0,n=0;for(const r of this.SIGNATURE_CLASSES)(e.includes(`class="${r}"`)||e.includes(`class='${r}'`))&&(t+=.4,n++);const r=e.toLowerCase();for(const e of this.SIGNATURE_PATTERNS)r.includes(e.toLowerCase())&&(t+=.2,n++);return/@[a-z0-9.-]+\.[a-z]{2,}/i.test(e)&&(t+=.2,n++),/\d{3}[-.\s]?\d{3}[-.\s]?\d{4}/.test(e)&&(t+=.1,n++),/<hr[\s>]/i.test(e)&&(t+=.1,n++),n>0?Math.min(t,1):0}extractSignature(e){const t=this.detectSignature(e);return-1===t?"":e.substring(t)}isLikelySignature(e){if(!e||e.length<3)return!1;const t=e.toLowerCase();for(const e of this.SIGNATURE_PATTERNS)if(t.includes(e.toLowerCase()))return!0;return/@[a-z0-9.-]+\.[a-z]{2,}/i.test(e)||/\d{3}[-.\s]?\d{3}[-.\s]?\d{4}/.test(e)}getSignaturePatterns(){return[...this.SIGNATURE_PATTERNS]}detectByClass(e){for(const t of this.SIGNATURE_CLASSES){const n=new RegExp(`<[^>]*class=["']${t}["'][^>]*>`,"i"),r=e.match(n);if(r&&void 0!==r.index)return r.index}return-1}detectByPattern(e){let t=-1;for(const n of this.SIGNATURE_PATTERNS){const r=e.toLowerCase().indexOf(n.toLowerCase());-1!==r&&(-1===t||r<t)&&this.verifySignatureStart(e,r)&&(t=r)}return t}detectByStructure(e){const t=e.match(/<hr[\s>]/i);if(t&&void 0!==t.index)return t.index;const n=e.split("\n");let r=0,s=0;for(let e=0;e<n.length;e++){const t=n[e]?.trim()||"";if(""===t)r++;else{if(r>=2&&this.isLikelySignature(t))return s;r=0}s+=(n[e]?.length||0)+1}return-1}verifySignatureStart(e,t){if(e.substring(0,t).trim().length<50)return!1;const n=e.substring(t,t+200);return this.isLikelySignature(n)||/@[a-z0-9.-]+\.[a-z]{2,}/i.test(n)}}},3480(e,t,n){n.a(e,async(e,r)=>{try{n.d(t,{f:()=>a});var s=n(8161),o=e([s]),i=o.then?(await o)():o;s=i[0];class a{tokenCounter;summarizationStats={totalSummarizations:0,totalTokensSaved:0};constructor(e){this.tokenCounter=e||new s.W}summarize(e,t,n="gpt-4"){const r=this.tokenCounter.countTokens(e,n);if(r<=t)return{content:e,wasSummarized:!1,originalTokenCount:r,finalTokenCount:r};const s=this.performSummarization(e,t,n),o=this.tokenCounter.countTokens(s,n);return this.summarizationStats.totalSummarizations++,this.summarizationStats.totalTokensSaved+=r-o,{content:s,wasSummarized:!0,originalTokenCount:r,finalTokenCount:o}}summarizeThread(e,t,n="gpt-4"){if(0===e.length)return{content:"",wasSummarized:!1,originalTokenCount:0,finalTokenCount:0};const r=e.map(e=>`From: ${e.from}\nDate: ${e.date}\n\n${e.content}`).join("\n\n---\n\n"),s=this.tokenCounter.countTokens(r,n);if(s<=t)return{content:r,wasSummarized:!1,originalTokenCount:s,finalTokenCount:s};let o="";const i=Math.min(3,e.length);for(let t=e.length-i;t<e.length;t++){const n=e[t];n&&(o=`From: ${n.from||"Unknown"}\nDate: ${n.date||"Unknown"}\n\n${n.content}\n\n---\n\n`+o)}if(e.length>i){const t=e.slice(0,e.length-i);o=`[Earlier messages summarized]\n\n${this.summarizeOlderMessages(t)}\n\n---\n\n${o}`}o=this.tokenCounter.truncateToLimit(o,t,n);const a=this.tokenCounter.countTokens(o,n);return this.summarizationStats.totalSummarizations++,this.summarizationStats.totalTokensSaved+=s-a,{content:o,wasSummarized:!0,originalTokenCount:s,finalTokenCount:a}}extractKeyPoints(e){if(!e||e.length<100)return e;const t=["IMPORTANT:","URGENT:","ACTION REQUIRED:","DEADLINE:"],n=e.split("\n"),r=[];for(const e of n){const n=e.toUpperCase();t.some(e=>n.includes(e))&&r.push(e)}return r.length>0?r.join("\n"):(e.match(/[^.!?]+[.!?]+/g)||[]).slice(0,3).join(" ")}estimateCompressionRatio(e){if(!e||e.length<100)return 1;let t=.7;return/[•\-*]\s/.test(e)&&(t-=.1),/^>/.test(e)&&(t-=.1),this.calculateRepetitionScore(e)>.3&&(t-=.1),Math.max(.3,Math.min(1,t))}getSummaryStats(){return{...this.summarizationStats}}performSummarization(e,t,n){if(t/this.tokenCounter.countTokens(e,n)>=.8)return this.tokenCounter.truncateToLimit(e,t,n);let r=`[Earlier messages summarized]\n\n${this.extractKeyPoints(e)}\n\n[Recent messages]\n\n${e.slice(-Math.floor(.3*e.length))}`;return r=this.tokenCounter.truncateToLimit(r,t,n),r}summarizeOlderMessages(e){return 0===e.length?"":`Previous conversation between ${e.length} participants:\n`+e.map(e=>this.extractKeyPoints(e.content)).join("\n")}calculateRepetitionScore(e){const t=e.toLowerCase().split(/\s+/),n=new Map;for(const e of t)e.length>3&&n.set(e,(n.get(e)||0)+1);let r=0;for(const e of n.values())e>2&&(r+=e-2);return r/t.length}}r()}catch(e){r(e)}})},6311(e,t,n){n.d(t,{g:()=>s});var r=n(3023);class s{client;abortController=null;constructor(e){if(!e||""===e.trim())throw new Error("API key is required");this.client=new r.Ay({apiKey:e,dangerouslyAllowBrowser:!0})}async generateResponse(e,t){const n=Date.now();try{this.abortController=new AbortController;const r=`${e.promptContent}\n\nEmail thread:\n${e.emailContent}`,s=await this.client.chat.completions.create({model:t,messages:[{role:"user",content:r}],temperature:.7},{signal:this.abortController.signal}),o=Date.now()-n,i=s.choices[0]?.message?.content||"";if(!i)throw new Error("No response generated from API");return{generatedText:i,tokensUsed:s.usage?.total_tokens||0,responseTime:o,timestamp:(new Date).toISOString(),wasSummarized:!1}}catch(e){if("AbortError"===e.name||e.message?.includes("aborted"))throw new Error("Request cancelled");if(401===e.status)throw new Error("Invalid API key. Please check your settings.");if(429===e.status)throw new Error("Rate limit exceeded. Please wait and try again.");if(400===e.status)throw new Error(e.message||"Content policy violation");if(e.status>=500)throw new Error("OpenAI API is temporarily unavailable. Please try again later.");throw e}finally{this.abortController=null}}async testConnection(){try{return await this.client.chat.completions.create({model:"gpt-4",messages:[{role:"user",content:"test"}],max_tokens:5}),!0}catch(e){if(401===e.status)throw new Error("Invalid API key");throw e}}cancel(){this.abortController&&this.abortController.abort()}}},8161(e,t,n){n.a(e,async(e,r)=>{try{n.d(t,{W:()=>a});var s=n(2671),o=e([s]),i=o.then?(await o)():o;s=i[0];class a{MODEL_LIMITS={"gpt-4":8192,"gpt-4o":128e3,"gpt-4-turbo":128e3,"gpt-3.5-turbo":16385};MODEL_PRICING={"gpt-4":{input:.03,output:.06},"gpt-4o":{input:.005,output:.015},"gpt-4-turbo":{input:.01,output:.03},"gpt-3.5-turbo":{input:.0015,output:.002}};countTokens(e,t="gpt-4"){if(!e||""===e.trim())return 0;try{const n=this.getEncodingForModel(t),r=n.encode(e);return n.free(),r.length}catch(t){return this.estimateTokens(e)}}estimateTokens(e){return e&&""!==e.trim()?Math.ceil(e.length/4):0}checkLimit(e,t,n="gpt-4"){const r=this.countTokens(e,n);return{withinLimit:r<=t,tokenCount:r,tokensRemaining:t-r}}getModelLimit(e){return this.MODEL_LIMITS[e]||4096}truncateToLimit(e,t,n="gpt-4"){if(!e)return"";if(this.countTokens(e,n)<=t)return e;let r=0,s=e.length,o="";for(;r<s;){const i=Math.floor((r+s+1)/2),a=e.substring(0,i);this.countTokens(a,n)<=t?(o=a,r=i):s=i-1}const i=o.lastIndexOf(" ");return i>.9*o.length&&(o=o.substring(0,i)),o}calculateCost(e,t,n){const r=this.MODEL_PRICING[n];return r?e/1e3*r.input+t/1e3*r.output:0}getEncodingForModel(e){try{return(0,s.cI)(e)}catch{return(0,s.TR)("cl100k_base")}}}r()}catch(e){r(e)}})},6394(e,t,n){n.d(t,{F:()=>m});var r=n(4848),s=n(8610),o=n(6922),i=n(6760),a=n(813),c=n(4541),l=n(2558),u=n(28),g=n(9883);const d=(0,c.n)({container:{marginBottom:l.L.spacingVerticalM},actions:{display:"flex",gap:l.L.spacingHorizontalS,marginTop:l.L.spacingVerticalS}}),m=({message:e,onRetry:t,onDismiss:n})=>{const c=d();return(0,r.jsx)(s.n,{intent:"error",className:c.container,children:(0,r.jsxs)(o.R,{children:[(0,r.jsx)(i.V,{children:"Error"}),e,(0,r.jsxs)("div",{className:c.actions,children:[t&&(0,r.jsx)(a.$,{appearance:"primary",size:"small",icon:(0,r.jsx)(u.M5p,{}),onClick:t,children:"Retry"}),n&&(0,r.jsx)(a.$,{appearance:"secondary",size:"small",icon:(0,r.jsx)(g.BEt,{}),onClick:n,children:"Dismiss"})]})]})})}},9059(e,t,n){n.d(t,{v:()=>E});var r=n(4848),s=n(4541),o=n(2558),i=n(2784),a=n(1439),c=n(4938),l=n(6540),u=n(9932),g=n(6117),d=n(9437),m=n(813),h=n(1273),p=n(6014);const S=(0,s.n)({container:{display:"flex",flexDirection:"column",gap:o.L.spacingVerticalM,padding:o.L.spacingVerticalL},stepContainer:{display:"flex",flexDirection:"column",gap:o.L.spacingVerticalS},step:{display:"flex",alignItems:"center",gap:o.L.spacingHorizontalS,padding:o.L.spacingVerticalS,borderRadius:o.L.borderRadiusMedium},activeStep:{backgroundColor:o.L.colorNeutralBackground1Selected,fontWeight:o.L.fontWeightSemibold},completedStep:{color:o.L.colorNeutralForeground3},progressBar:{width:"100%"},errorMessage:{color:o.L.colorPaletteRedForeground1,padding:o.L.spacingVerticalS,borderRadius:o.L.borderRadiusMedium,backgroundColor:o.L.colorPaletteRedBackground1},actions:{display:"flex",justifyContent:"flex-end",marginTop:o.L.spacingVerticalM},timeEstimate:{color:o.L.colorNeutralForeground3,fontSize:o.L.fontSizeBase200},warningNotice:{display:"flex",alignItems:"flex-start",gap:o.L.spacingHorizontalS,padding:o.L.spacingVerticalS,borderRadius:o.L.borderRadiusMedium,backgroundColor:o.L.colorPaletteYellowBackground1,color:o.L.colorPaletteYellowForeground1,marginTop:o.L.spacingVerticalS}}),f=({currentStep:e,onCancel:t,error:n,estimatedTime:s,wasSummarized:o=!1,originalTokenCount:i,finalTokenCount:a})=>{const c=S(),[f,y]=(0,l.useState)(!1),E=[{id:"preparing",label:"Preparing request"},{id:"sending",label:"Sending to ChatGPT"},{id:"generating",label:"Generating response"},{id:"done",label:"Complete"}],T=(E.findIndex(t=>t.id===e)+1)/E.length*100,w=t=>{const n=c.step;if(t===e)return`${n} ${c.activeStep}`;const r=E.findIndex(t=>t.id===e);return E.findIndex(e=>e.id===t)<r?`${n} ${c.completedStep}`:n},C="done"!==e&&!n;return(0,r.jsxs)("div",{className:c.container,children:[(0,r.jsx)(u.z,{className:c.progressBar,value:T,role:"progressbar","aria-valuenow":T,"aria-valuemin":0,"aria-valuemax":100,"aria-label":"Generation progress"}),(0,r.jsx)("div",{className:c.stepContainer,children:E.map(t=>(0,r.jsxs)("div",{className:w(t.id),children:[t.id===e&&!n&&(0,r.jsx)(g.y,{size:"tiny",role:"status","aria-label":"Loading"}),(0,r.jsx)(d.E,{children:t.label}),t.id===e&&s&&(0,r.jsxs)(d.E,{className:c.timeEstimate,children:["(~",s," seconds)"]})]},t.id))}),(0,r.jsxs)(d.E,{weight:"semibold",children:[Math.round(T),"% complete"]}),o&&(0,r.jsxs)("div",{className:c.warningNotice,role:"alert",children:[(0,r.jsx)(h.rg6,{}),(0,r.jsxs)("div",{children:[(0,r.jsx)(d.E,{weight:"semibold",children:"Email thread was summarized"}),(0,r.jsx)("br",{}),(0,r.jsxs)(d.E,{size:200,children:["The email content exceeded token limits and was automatically summarized",i&&a&&` (${i} → ${a} tokens)`,"."]})]})]}),n&&(0,r.jsx)("div",{className:c.errorMessage,role:"alert",children:(0,r.jsx)(d.E,{children:n})}),C&&(0,r.jsx)("div",{className:c.actions,children:(0,r.jsx)(m.$,{appearance:"secondary",icon:(0,r.jsx)(p.Jtj,{}),onClick:()=>{y(!0),t()},disabled:f,"aria-label":"Cancel generation",children:"Cancel"})})]})},y=(0,s.n)({dialogSurface:{minWidth:"400px",maxWidth:"600px"},dialogBody:{padding:o.L.spacingVerticalL}}),E=({isOpen:e,currentStep:t,onCancel:n,error:s,estimatedTime:o})=>{const l=y();return(0,r.jsx)(i.l,{open:e,modalType:"modal",children:(0,r.jsx)(a.E,{className:l.dialogSurface,children:(0,r.jsx)(c.R,{className:l.dialogBody,children:(0,r.jsx)(f,{currentStep:t,onCancel:n,error:s,estimatedTime:o})})})})}},444(e,t,n){n.a(e,async(e,r)=>{try{n.d(t,{A:()=>d});var s=n(6540),o=n(6311),i=n(8161),a=n(3480),c=n(3701),l=n(7762),u=n(645),g=e([i,a]);[i,a]=g.then?(await g)():g;const d=()=>{const[e,t]=(0,s.useState)(!1),[n,r]=(0,s.useState)("preparing"),[g,d]=(0,s.useState)(null),[h,p]=(0,s.useState)(!1),[S,f]=(0,s.useState)(null),[y,E]=(0,s.useState)(null),T=(0,s.useRef)(null),w=(0,s.useRef)(null),C=(0,s.useCallback)(async(e,n,s)=>{w.current={promptContent:e,apiKey:n,model:s},t(!0),d(null),r("preparing"),p(!1),f(null),E(null);try{const g=new c.Q,d=new i.W,m=new a.f(d),h=new l.Z,S=new u.U,y=await new Promise((e,t)=>{Office.context.mailbox?.item?.body?Office.context.mailbox.item.body.getAsync(Office.CoercionType.Html,n=>{n.status!==Office.AsyncResultStatus.Failed?e(n.value||""):t(new Error(n.error?.message||"Failed to get email body"))}):t(new Error("Not in compose mode"))});if(!y||""===y.trim())throw new Error("No email content found. Please ensure you are composing a reply or have email content.");const w=await g.parseThread(y),C=g.combineMessagesForContext(w.messages),x=d.getModelLimit(s),b=Math.floor(.6*x),k=m.summarize(C,b,s);k.wasSummarized&&(console.log(`Content summarized: ${k.originalTokenCount} → ${k.finalTokenCount} tokens`),p(!0),f(k.originalTokenCount||0),E(k.finalTokenCount||0));const A={emailContent:k.content,promptContent:e,timestamp:(new Date).toISOString(),model:"gpt-4"};r("sending"),T.current=new o.g(n),r("generating");const v=await T.current.generateResponse(A,s);r("done");const R=h.detectSignature(y);await S.insertContent(v.generatedText,R),t(!1)}catch(e){d(m(e)),t(!1)}},[]),x=(0,s.useCallback)(()=>{T.current&&T.current.cancel(),t(!1),d("Generation cancelled")},[]),b=(0,s.useCallback)(()=>{if(w.current){const{promptContent:e,apiKey:t,model:n}=w.current;C(e,t,n)}},[C]),k=(0,s.useCallback)(()=>{d(null)},[]);return{isGenerating:e,currentStep:n,error:g,wasSummarized:h,originalTokenCount:S,finalTokenCount:y,generate:C,cancel:x,retry:b,clearError:k}};function m(e){const t=e.message||e.toString();return t.includes("Invalid API key")||t.includes("401")?"Invalid API key. Please check your settings and ensure your key is correct.":t.includes("Rate limit")||t.includes("429")?"Rate limit exceeded. Please wait a moment and try again.":t.includes("temporarily unavailable")||t.includes("500")?"OpenAI API is temporarily unavailable. Please try again later.":t.includes("API key is required")?"No API key configured. Please configure your API key in settings.":t.includes("policy")||t.includes("400")?`Content policy violation: ${t}`:t.includes("cancelled")||t.includes("aborted")?"Generation cancelled":`An error occurred: ${t}`}r()}catch(h){r(h)}})},3644(e,t,n){n.d(t,{t:()=>a});var r=n(6540);const s="outlook_addin_roaming_";function o(){return"undefined"!=typeof Office&&void 0!==Office.context&&void 0!==Office.context.roamingSettings}class i{STORAGE_KEYS={API_KEY:"settings_apiKey",SELECTED_MODEL:"settings_selectedModel",KEYBOARD_SHORTCUTS:"settings_keyboardShortcuts",LAST_UPDATED:"settings_lastUpdated"};DEFAULT_SETTINGS={apiKey:"",selectedModel:"gpt-4o",keyboardShortcuts:{},lastUpdated:(new Date).toISOString()};async getSettings(){try{const e=this.getFromLocalStorage(this.STORAGE_KEYS.API_KEY)||"",t=this.getFromRoamingSettings(this.STORAGE_KEYS.SELECTED_MODEL)||this.DEFAULT_SETTINGS.selectedModel;return{apiKey:e,selectedModel:t,keyboardShortcuts:this.getFromRoamingSettings(this.STORAGE_KEYS.KEYBOARD_SHORTCUTS)||{},lastUpdated:this.getFromRoamingSettings(this.STORAGE_KEYS.LAST_UPDATED)||this.DEFAULT_SETTINGS.lastUpdated}}catch(e){return console.error("Error loading settings:",e),{...this.DEFAULT_SETTINGS}}}async saveSettings(e){try{this.saveToLocalStorage(this.STORAGE_KEYS.API_KEY,e.apiKey),this.saveToRoamingSettings(this.STORAGE_KEYS.SELECTED_MODEL,e.selectedModel),this.saveToRoamingSettings(this.STORAGE_KEYS.KEYBOARD_SHORTCUTS,e.keyboardShortcuts);const t=(new Date).toISOString();this.saveToRoamingSettings(this.STORAGE_KEYS.LAST_UPDATED,t),await this.saveRoamingSettingsAsync()}catch(e){throw console.error("Error saving settings:",e),new Error("Failed to save settings")}}async clearSettings(){try{this.removeFromLocalStorage(this.STORAGE_KEYS.API_KEY),this.removeFromRoamingSettings(this.STORAGE_KEYS.SELECTED_MODEL),this.removeFromRoamingSettings(this.STORAGE_KEYS.KEYBOARD_SHORTCUTS),this.removeFromRoamingSettings(this.STORAGE_KEYS.LAST_UPDATED),await this.saveRoamingSettingsAsync()}catch(e){throw console.error("Error clearing settings:",e),new Error("Failed to clear settings")}}async hasApiKey(){return(await this.getSettings()).apiKey.trim().length>0}getFromLocalStorage(e){try{return localStorage.getItem(e)}catch(t){return console.error(`Error reading from localStorage (${e}):`,t),null}}saveToLocalStorage(e,t){try{localStorage.setItem(e,t)}catch(t){throw console.error(`Error writing to localStorage (${e}):`,t),t}}removeFromLocalStorage(e){try{localStorage.removeItem(e)}catch(t){console.error(`Error removing from localStorage (${e}):`,t)}}getFromRoamingSettings(e){if(o())try{return Office.context.roamingSettings.get(e)}catch(t){return console.error(`Error reading from roaming settings (${e}):`,t),null}try{const t=localStorage.getItem(s+e);return t?JSON.parse(t):null}catch{return null}}saveToRoamingSettings(e,t){if(o())try{Office.context.roamingSettings.set(e,t)}catch(t){throw console.error(`Error writing to roaming settings (${e}):`,t),t}else try{localStorage.setItem(s+e,JSON.stringify(t))}catch(t){console.error(`Error writing to localStorage fallback (${e}):`,t)}}removeFromRoamingSettings(e){if(o())try{Office.context.roamingSettings.remove(e)}catch(t){console.error(`Error removing from roaming settings (${e}):`,t)}else try{localStorage.removeItem(s+e)}catch{}}saveRoamingSettingsAsync(){return o()?new Promise((e,t)=>{try{Office.context.roamingSettings.saveAsync(n=>{n.status===Office.AsyncResultStatus.Succeeded?e():t(new Error(`Failed to save roaming settings: ${n.error?.message}`))})}catch(e){t(e)}}):Promise.resolve()}}const a=()=>{const[e,t]=(0,r.useState)({apiKey:"",selectedModel:"gpt-4o",keyboardShortcuts:{},lastUpdated:(new Date).toISOString()}),[n,s]=(0,r.useState)(!0),[o,a]=(0,r.useState)(null),[c]=(0,r.useState)(()=>new i);(0,r.useEffect)(()=>{(async()=>{try{s(!0),a(null);const e=await c.getSettings();t(e)}catch(e){a("Failed to load settings"),console.error("Error loading settings:",e)}finally{s(!1)}})()},[c]);const l=(0,r.useCallback)(async n=>{try{a(null);const r={...e,...n,lastUpdated:(new Date).toISOString()};await c.saveSettings(r),t(r)}catch(e){throw a("Failed to save settings"),console.error("Error saving settings:",e),e}},[e,c]),u=(0,r.useCallback)(async()=>{try{a(null),await c.clearSettings();const e=await c.getSettings();t(e)}catch(e){throw a("Failed to reset settings"),console.error("Error resetting settings:",e),e}},[c]),g=e.apiKey.trim().length>0;return{settings:e,isLoading:n,error:o,updateSettings:l,resetSettings:u,hasApiKey:g}}}}]);